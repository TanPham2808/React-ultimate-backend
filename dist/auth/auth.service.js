'use strict';var _0x2ef2fb=_0x5364;function _0x5364(_0x114d44,_0x2eb766){var _0x2d45dc=_0x2d45();return _0x5364=function(_0x536431,_0x359142){_0x536431=_0x536431-0x1ab;var _0x418506=_0x2d45dc[_0x536431];return _0x418506;},_0x5364(_0x114d44,_0x2eb766);}(function(_0x46a333,_0x11113f){var _0x3ef190=_0x5364,_0x4689a9=_0x46a333();while(!![]){try{var _0x4cc27e=-parseInt(_0x3ef190(0x1e5))/0x1+-parseInt(_0x3ef190(0x1e0))/0x2+parseInt(_0x3ef190(0x1c7))/0x3+parseInt(_0x3ef190(0x1be))/0x4*(parseInt(_0x3ef190(0x1ca))/0x5)+-parseInt(_0x3ef190(0x1b1))/0x6*(-parseInt(_0x3ef190(0x1ea))/0x7)+-parseInt(_0x3ef190(0x1dd))/0x8+parseInt(_0x3ef190(0x1ad))/0x9;if(_0x4cc27e===_0x11113f)break;else _0x4689a9['push'](_0x4689a9['shift']());}catch(_0x5b320c){_0x4689a9['push'](_0x4689a9['shift']());}}}(_0x2d45,0x2759b));function _0x2d45(){var _0x2354c3=['986447kwaEth','design:paramtypes','defineProperty','Hết\x20hạn\x20refresh_token.\x20Please\x20do\x20login\x20again.','JwtService','JpFID','role','JWT_REFRESH_SECRET','verify','phone','4096449MsNxNp','prototype','cookies','refresh_token','6xqXGrV','_id','decorate','logout','login','length','sign','getOwnPropertyDescriptor','Logout\x20success.','handleRefreshToken','validateUser','XGYbK','body','10828PviiKy','userService','__param','delay','fetchAccount','Không\x20tồn\x20tại\x20refresh_token\x20ở\x20database.\x20Please\x20do\x20login\x20again.','UserService','__esModule','createRefreshToken','96552dDrdKk','function','handleUserLogout','390tDnvtz','c21f969b5f03d33d43e04f8f136e7682.png','email','AuthService','@nestjs/common','clearCookie','design:returntype','../user/user.service','updateUserToken','config','env','default','jwtService','cookie','fullName','JWT_REFRESH_EXPIRE_IN','compareSync','__importDefault','design:type','2322696XhVmYC','avatar','object','175480IjqxuP','BadRequestException','findUserByToken','Req','password','300156pQqDjE','Res','ilxDA','sub','metadata'];_0x2d45=function(){return _0x2354c3;};return _0x2d45();}var __decorate=this&&this['__decorate']||function(_0x351523,_0x29ffe7,_0x964a87,_0x45a5ab){var _0x57a854=_0x5364,_0x3de7b8,_0x4ef197=arguments['length'],_0x377c2a=_0x4ef197<0x3?_0x29ffe7:null===_0x45a5ab?_0x45a5ab=Object[_0x57a854(0x1b8)](_0x29ffe7,_0x964a87):_0x45a5ab;if(_0x57a854(0x1df)==typeof Reflect&&_0x57a854(0x1c8)==typeof Reflect[_0x57a854(0x1b3)])_0x377c2a=Reflect[_0x57a854(0x1b3)](_0x351523,_0x29ffe7,_0x964a87,_0x45a5ab);else{for(var _0x492aa7=_0x351523[_0x57a854(0x1b6)]-0x1;0x0<=_0x492aa7;_0x492aa7--)(_0x3de7b8=_0x351523[_0x492aa7])&&(_0x377c2a=(_0x4ef197<0x3?_0x3de7b8(_0x377c2a):0x3<_0x4ef197?_0x3de7b8(_0x29ffe7,_0x964a87,_0x377c2a):_0x3de7b8(_0x29ffe7,_0x964a87))||_0x377c2a);}return 0x3<_0x4ef197&&_0x377c2a&&Object[_0x57a854(0x1ec)](_0x29ffe7,_0x964a87,_0x377c2a),_0x377c2a;},__metadata=this&&this['__metadata']||function(_0x300c06,_0x5e19be){var _0xcbb53a=_0x5364;if(_0xcbb53a(0x1df)==typeof Reflect&&'function'==typeof Reflect[_0xcbb53a(0x1e9)])return Reflect[_0xcbb53a(0x1e9)](_0x300c06,_0x5e19be);},__param=this&&this[_0x2ef2fb(0x1c0)]||function(_0x1d15d8,_0x2af623){return function(_0x25f91b,_0x4221fc){_0x2af623(_0x25f91b,_0x4221fc,_0x1d15d8);};},__importDefault=this&&this[_0x2ef2fb(0x1db)]||function(_0x5d9f92){var _0x5ce62b=_0x2ef2fb;return _0x5d9f92&&_0x5d9f92[_0x5ce62b(0x1c5)]?_0x5d9f92:{'default':_0x5d9f92};};Object[_0x2ef2fb(0x1ec)](exports,_0x2ef2fb(0x1c5),{'value':!0x0}),exports[_0x2ef2fb(0x1cd)]=void 0x0;const common_1=require(_0x2ef2fb(0x1ce)),user_service_1=require(_0x2ef2fb(0x1d1)),jwt_1=require('@nestjs/jwt'),ms_1=__importDefault(require('ms')),bcrypt=(require('dotenv')[_0x2ef2fb(0x1d3)](),require('bcryptjs'));let AuthService=class{constructor(_0xe47d6f,_0x1fe750){var _0x544ccb=_0x2ef2fb;this[_0x544ccb(0x1bf)]=_0xe47d6f,this[_0x544ccb(0x1d6)]=_0x1fe750;}async[_0x2ef2fb(0x1bb)](_0x37a0b1,_0x390521){var _0x4f6d6e=_0x2ef2fb;_0x37a0b1=await this[_0x4f6d6e(0x1bf)]['findByUsername'](_0x37a0b1);if(_0x37a0b1&&bcrypt[_0x4f6d6e(0x1da)](_0x390521,_0x37a0b1[_0x4f6d6e(0x1e4)]))return _0x37a0b1[_0x4f6d6e(0x1e4)]=void 0x0,_0x37a0b1;throw new common_1[(_0x4f6d6e(0x1e1))]('Thông\x20tin\x20đăng\x20nhập\x20không\x20chính\x20xác');}async['login'](_0x30f8d4,_0x5440af,_0x1763db){var _0x318bf2=_0x2ef2fb;const _0x22b2bd={'email':_0x30f8d4[_0x318bf2(0x1cc)],'phone':_0x30f8d4['phone'],'fullName':_0x30f8d4['fullName'],'role':_0x30f8d4[_0x318bf2(0x1f0)],'sub':_0x30f8d4[_0x318bf2(0x1b2)],'avatar':_0x30f8d4&&_0x30f8d4[_0x318bf2(0x1de)]?_0x30f8d4[_0x318bf2(0x1de)]:_0x318bf2(0x1cb)};var _0x481127=this['createRefreshToken'](_0x22b2bd);return await this[_0x318bf2(0x1bf)][_0x318bf2(0x1d2)](_0x30f8d4[_0x318bf2(0x1b2)],_0x481127),_0x5440af[_0x318bf2(0x1d7)](_0x318bf2(0x1b0),_0x481127,{'maxAge':(0x0,ms_1[_0x318bf2(0x1d5)])(process[_0x318bf2(0x1d4)]['JWT_REFRESH_EXPIRE_IN']),'httpOnly':!0x0}),null!=(_0x5440af=null==_0x1763db?void 0x0:_0x1763db['body'])&&_0x5440af[_0x318bf2(0x1c1)]?new Promise((_0xdd3015,_0x3f45cf)=>{var _0x10ced1=_0x318bf2;if(_0x10ced1(0x1ef)!==_0x10ced1(0x1ef))throw _0x514025['clearCookie'](_0x10ced1(0x1b0)),new _0x26c0de[(_0x10ced1(0x1e1))]('Hết\x20hạn\x20refresh_token.\x20Please\x20do\x20login\x20again.');else{var _0x14d122;setTimeout(()=>{var _0x59a1d8=_0x10ced1;if(_0x59a1d8(0x1e7)===_0x59a1d8(0x1bc)){var {_id:_0x164d87,phone:_0x4c2554,email:_0x456529,fullName:_0x58c7d5,role:_0x3c9c34,avatar:_0x3bde81}=_0x164d87;return{'user':{'id':_0x164d87,'email':_0x456529,'phone':_0x4c2554,'fullName':_0x58c7d5,'role':_0x3c9c34,'avatar':_0x3bde81}};}else _0xdd3015({'access_token':this['jwtService']['sign'](_0x22b2bd),'user':{'email':_0x30f8d4['email'],'phone':_0x30f8d4[_0x59a1d8(0x1ac)],'fullName':_0x30f8d4[_0x59a1d8(0x1d8)],'role':_0x30f8d4['role'],'avatar':_0x30f8d4[_0x59a1d8(0x1de)],'id':_0x30f8d4[_0x59a1d8(0x1b2)]}});},+(null==(_0x14d122=null==_0x1763db?void 0x0:_0x1763db[_0x10ced1(0x1bd)])?void 0x0:_0x14d122['delay']));}}):{'access_token':this[_0x318bf2(0x1d6)][_0x318bf2(0x1b7)](_0x22b2bd),'user':{'email':_0x30f8d4[_0x318bf2(0x1cc)],'phone':_0x30f8d4[_0x318bf2(0x1ac)],'fullName':_0x30f8d4[_0x318bf2(0x1d8)],'role':_0x30f8d4[_0x318bf2(0x1f0)],'avatar':_0x30f8d4[_0x318bf2(0x1de)],'id':_0x30f8d4[_0x318bf2(0x1b2)]}};}[_0x2ef2fb(0x1c6)](_0x27c3d7){var _0x35acd2=_0x2ef2fb;return this[_0x35acd2(0x1d6)][_0x35acd2(0x1b7)](_0x27c3d7,{'secret':process['env'][_0x35acd2(0x1f1)],'expiresIn':process[_0x35acd2(0x1d4)][_0x35acd2(0x1d9)]});}async[_0x2ef2fb(0x1c2)](_0x10ca42){var {_id:_0x10ca42,phone:_0x5a1fc6,email:_0x2874bf,fullName:_0x2567b0,role:_0x52576a,avatar:_0x219c96}=_0x10ca42;return{'user':{'id':_0x10ca42,'email':_0x2874bf,'phone':_0x5a1fc6,'fullName':_0x2567b0,'role':_0x52576a,'avatar':_0x219c96}};}async[_0x2ef2fb(0x1b4)](_0x124e49,_0x3a912f){var _0x4ec6d8=_0x2ef2fb;return _0x3a912f[_0x4ec6d8(0x1cf)]('refresh_token'),await this[_0x4ec6d8(0x1bf)][_0x4ec6d8(0x1c9)](_0x124e49),_0x4ec6d8(0x1b9);}async[_0x2ef2fb(0x1ba)](_0x18fff5,_0x2d3a01){var _0x1f1541=_0x2ef2fb;if(null==(_0x4d10c1=_0x18fff5[_0x1f1541(0x1af)])||!_0x4d10c1[_0x1f1541(0x1b0)])throw new common_1[(_0x1f1541(0x1e1))]('Không\x20tồn\x20tại\x20refresh_token\x20ở\x20cookies.\x20Please\x20do\x20login\x20again.');const _0x5de3d6=_0x18fff5[_0x1f1541(0x1af)]['refresh_token'];var _0x4d10c1=await this['userService'][_0x1f1541(0x1e2)](_0x5de3d6);if(!_0x4d10c1)throw new common_1['BadRequestException'](_0x1f1541(0x1c3));try{var _0x1effbd=this[_0x1f1541(0x1d6)][_0x1f1541(0x1ab)](_0x5de3d6,{'secret':process[_0x1f1541(0x1d4)][_0x1f1541(0x1f1)]});if(_0x1effbd){var _0x59aa55={'email':_0x1effbd['email'],'phone':_0x4d10c1[_0x1f1541(0x1ac)],'fullName':_0x4d10c1[_0x1f1541(0x1d8)],'role':_0x1effbd[_0x1f1541(0x1f0)],'sub':_0x1effbd['sub'],'avatar':_0x4d10c1&&_0x4d10c1['avatar']?_0x4d10c1['avatar']:'c21f969b5f03d33d43e04f8f136e7682.png'};const _0x51018b=this[_0x1f1541(0x1c6)](_0x59aa55);return await this['userService'][_0x1f1541(0x1d2)](_0x1effbd['sub'],_0x51018b),_0x2d3a01[_0x1f1541(0x1d7)](_0x1f1541(0x1b0),_0x51018b,{'maxAge':(0x0,ms_1[_0x1f1541(0x1d5)])(process[_0x1f1541(0x1d4)][_0x1f1541(0x1d9)]),'httpOnly':!0x0}),{'access_token':this[_0x1f1541(0x1d6)][_0x1f1541(0x1b7)](_0x59aa55),'user':{'email':_0x1effbd['email'],'phone':_0x1effbd[_0x1f1541(0x1ac)],'fullName':_0x1effbd[_0x1f1541(0x1d8)],'role':_0x1effbd[_0x1f1541(0x1f0)],'avatar':_0x1effbd[_0x1f1541(0x1de)],'id':_0x1effbd[_0x1f1541(0x1e8)]}};}}catch(_0x298852){throw _0x2d3a01[_0x1f1541(0x1cf)](_0x1f1541(0x1b0)),new common_1[(_0x1f1541(0x1e1))](_0x1f1541(0x1ed));}}};exports[_0x2ef2fb(0x1cd)]=AuthService,__decorate([__param(0x1,(0x0,common_1['Res'])({'passthrough':!0x0})),__param(0x2,(0x0,common_1[_0x2ef2fb(0x1e3)])()),__metadata(_0x2ef2fb(0x1dc),Function),__metadata(_0x2ef2fb(0x1eb),[Object,Object,Object]),__metadata('design:returntype',Promise)],AuthService['prototype'],_0x2ef2fb(0x1b5),null),__decorate([__param(0x1,(0x0,common_1[_0x2ef2fb(0x1e6)])({'passthrough':!0x0})),__metadata(_0x2ef2fb(0x1dc),Function),__metadata(_0x2ef2fb(0x1eb),[String,Object]),__metadata(_0x2ef2fb(0x1d0),Promise)],AuthService[_0x2ef2fb(0x1ae)],_0x2ef2fb(0x1b4),null),__decorate([__param(0x1,(0x0,common_1[_0x2ef2fb(0x1e6)])({'passthrough':!0x0})),__metadata(_0x2ef2fb(0x1dc),Function),__metadata('design:paramtypes',[Object,Object]),__metadata(_0x2ef2fb(0x1d0),Promise)],AuthService[_0x2ef2fb(0x1ae)],_0x2ef2fb(0x1ba),null),exports[_0x2ef2fb(0x1cd)]=AuthService=__decorate([(0x0,common_1['Injectable'])(),__metadata(_0x2ef2fb(0x1eb),[user_service_1[_0x2ef2fb(0x1c4)],jwt_1[_0x2ef2fb(0x1ee)]])],AuthService);